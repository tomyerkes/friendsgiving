<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Friendsgiving Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Silence favicon 404s -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <meta name="color-scheme" content="light only">
</head>
<body class="bg-orange-50 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold text-orange-800">üçÇ Mandi's Friendsgiving Planner üçÇ</h1>
      <p class="text-sm text-orange-900/80 mt-1">Pick the dates that work for you and claim what you‚Äôll bring.</p>
    </header>

    <div id="notice" class="hidden mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-900 text-sm"></div>

    <form id="fgForm" class="space-y-6 bg-white p-5 rounded-2xl shadow">
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Your Name</span>
          <input required name="name" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Jane Doe" />
        </label>
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Email</span>
          <input required type="email" name="email" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="jane@example.com" />
        </label>
      </div>

      <div>
        <h2 class="text-lg font-semibold text-slate-800">Dates you can attend</h2>
        <p class="text-xs text-slate-500">(Fridays, Saturdays, and Sundays in November & December 2025)</p>
        <div id="dateList" class="mt-2 grid sm:grid-cols-2 gap-2"></div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold text-slate-800">Main Course</h3>
          <div id="mainList" class="mt-2 space-y-2"></div>
          <input name="mainOther" id="mainOther" class="hidden mt-2 w-full rounded-xl border px-3 py-2" placeholder="Other (please specify)" />
        </div>
        <div>
          <h3 class="font-semibold text-slate-800">Side Dish</h3>
          <div id="sideList" class="mt-2 space-y-2"></div>
          <input name="sideOther" id="sideOther" class="hidden mt-2 w-full rounded-xl border px-3 py-2" placeholder="Other (please specify)" />
        </div>
        <div>
          <h3 class="font-semibold text-slate-800">Dessert</h3>
          <div id="dessertList" class="mt-2 space-y-2"></div>
          <input name="dessertOther" id="dessertOther" class="hidden mt-2 w-full rounded-xl border px-3 py-2" placeholder="Other (please specify)" />
        </div>
        <div>
          <h3 class="font-semibold text-slate-800">Drinks</h3>
          <div id="drinkList" class="mt-2 space-y-2"></div>
          <input name="drinkOther" id="drinkOther" class="hidden mt-2 w-full rounded-xl border px-3 py-2" placeholder="Other (please specify)" />
        </div>
      </div>

      <button class="w-full rounded-2xl bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3">Submit</button>
      <p class="text-xs text-center text-slate-500">You‚Äôll see items disabled once they‚Äôre claimed up to their limit.</p>
    </form>

    <section class="mt-8">
      <h2 class="text-lg font-semibold text-slate-800">Current Signups (live)</h2>
      <div id="legend" class="text-xs text-slate-600">Loading availability‚Ä¶</div>
      <div id="signupsList" class="mt-3 space-y-2"></div>
    </section>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx4f1bHUV-EUhD32QzDfjfz0se6BQXDzuH5W3ukYa9N9F3ECJYHUBMElwWd6XiPC2Uf/exec"; // <-- replace with your /exec URL
    const el = sel => document.querySelector(sel);

    // ------- Dates (Weekends Nov & Dec 2025) -------
    const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DOW_ABBR = ["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."];

    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n + (s[(v-20)%10] || s[v] || s[0]);
    }

    function weekendDatesNovDec2025(){
      const dates=[];
      [10,11].forEach(m=>{ // 10=Nov, 11=Dec
        const lastDay = new Date(2025, m+1, 0).getDate();
        for(let d=1; d<=lastDay; d++){
          const dt = new Date(2025, m, d);
          const wd = dt.getDay(); // 0=Sun ... 6=Sat
          if (wd===5 || wd===6 || wd===0){ // Fri/Sat/Sun
            const label = `${MONTH_NAMES[m]} ${ordinal(d)} 2025 - ${DOW_ABBR[wd]}`;
            const value = dt.toISOString().split('T')[0]; // YYYY-MM-DD
            dates.push({label,value});
          }
        }
      });
      return dates;
    }

    // ------- Backend -------
    async function loadConfig() {
      const url = `${API_URL}?action=config`;
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status} ‚Äì ${txt.slice(0,200)}`);
      }
      return res.json();
    }

    // ------- Rendering -------
    function renderDates(dateObjs) {
      const wrap = el('#dateList');
      wrap.innerHTML = '';
      dateObjs.forEach(({label,value}) => {
        wrap.insertAdjacentHTML('beforeend', `
          <label class="flex items-center gap-2 rounded-xl border p-2">
            <input type="checkbox" name="dates" value="${value}" class="h-4 w-4" />
            <span>${label}</span>
          </label>
        `);
      });
    }

    function renderCategory(catId, items, counts) {
      const wrap = el(`#${catId}List`);
      wrap.innerHTML = '';
      items.forEach(({ item, max }) => {
        const taken = counts[item] || 0;
        const full = taken >= max;
        wrap.insertAdjacentHTML('beforeend', `
          <label class="flex items-start gap-2 rounded-xl border p-2 ${full ? 'opacity-50' : ''}">
            <input type="radio" name="${catId}" value="${item}" ${full ? 'disabled' : ''} class="mt-1" />
            <div>
              <div class="font-medium">${item}</div>
              <div class="text-xs text-slate-500">${taken}/${max} claimed</div>
            </div>
          </label>
        `);
      });
      // Add "Other" option + show the input when selected
      wrap.insertAdjacentHTML('beforeend', `
        <label class="flex items-start gap-2 rounded-xl border p-2">
          <input type="radio" name="${catId}" value="Other" class="mt-1" />
          <div>
            <div class="font-medium">Other</div>
            <div class="text-xs text-slate-500">Type your own below</div>
          </div>
        </label>
      `);
      wrap.addEventListener('change', (e) => {
        const otherInput = el(`#${catId}Other`);
        if (e.target.name === catId && e.target.value === 'Other') {
          otherInput.classList.remove('hidden');
        } else if (e.target.name === catId) {
          otherInput.classList.add('hidden');
          otherInput.value = '';
        }
      });
    }

    function renderSignups(signups) {
      const wrap = document.querySelector('#signupsList');
      wrap.innerHTML = '';
      if (!signups || !signups.length) {
        wrap.innerHTML = '<div class="text-sm text-slate-500">No signups yet.</div>';
        return;
      }
      signups.forEach(s => {
        const dates = (s.dates || []).join(' ‚Ä¢ ');
        const picks = s.picks || {};
        wrap.insertAdjacentHTML('beforeend', `
          <div class="rounded-xl border p-3 bg-slate-50">
            <div class="font-medium">${s.name || 'Anonymous'}</div>
            <div class="text-xs text-slate-600 mt-0.5">${dates || 'No date selected'}</div>
            <div class="text-sm mt-1">
              <span class="font-semibold">Main:</span> ${picks.main || '-'} ‚Ä¢
              <span class="font-semibold">Side:</span> ${picks.side || '-'} ‚Ä¢
              <span class="font-semibold">Dessert:</span> ${picks.dessert || '-'} ‚Ä¢
              <span class="font-semibold">Drink:</span> ${picks.drink || '-'}
            </div>
          </div>
        `);
      });
    }

    function applyData({ options, counts, signups }) {
      renderDates(weekendDatesNovDec2025());
      renderCategory('main', options.Main, counts.Main || {});
      renderCategory('side', options.Side, counts.Side || {});
      renderCategory('dessert', options.Dessert, counts.Dessert || {});
      renderCategory('drink', options.Drink, counts.Drink || {});
      el('#legend').textContent = 'Live availability updates as people sign up.';
      renderSignups(signups || []);
    }

    function showNotice(msg){
      const n=el('#notice');
      n.classList.remove('hidden');
      n.textContent=msg;
    }

    async function init(){
      try {
        const data = await loadConfig();
        applyData(data);
      } catch (err) {
        showNotice('Could not load availability. Try refreshing.');
        console.error('CONFIG/RENDER ERROR', err);
      }
    }

    // ------- Submit -------
    el('#fgForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const name = form.name.value.trim();
      const email = form.email.value.trim();
      const dates = [...document.querySelectorAll('input[name="dates"]:checked')].map(i => i.value);
      const picks = {
        main: form.main?.value === 'Other' ? form.mainOther.value : form.main?.value || '',
        side: form.side?.value === 'Other' ? form.sideOther.value : form.side?.value || '',
        dessert: form.dessert?.value === 'Other' ? form.dessertOther.value : form.dessert?.value || '',
        drink: form.drink?.value === 'Other' ? form.drinkOther.value : form.drink?.value || ''
      };
      if (!name || !email) return showNotice('Please enter your name and email.');

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },  // avoids CORS preflight on Apps Script
          body: JSON.stringify({ name, email, dates, picks })
        });
        const data = await res.json();
        if (data.status !== 'ok') throw new Error(data.message || 'Error');
        showNotice('Thanks! Your response has been recorded.');
        const cfg = await loadConfig();
        applyData(cfg);
        form.reset();
      } catch (err) {
        showNotice('Submission failed. Please try again.');
        console.error('SUBMIT ERROR', err);
      }
    });

    init();
  </script>
</body>
</html>
